# H24 Smart Contract

## Data Structures

```
# информация по клиентам
miners:
  # адрес клиента
  addr:
    # первый день за который начисляются реварды
    date
    # количество застейканных токенов
    amount - количество застейканных токенов
```

```
# суммарное количество токенов
summary:
  # date - номер дня в виде timestamp/86400
  date: amount
```

```
# намайненные WBTC, которые нужно поделить между стейкхолдерами
rewards:
  # date - номер дня в виде timestamp/86400
  date: amount
```

```
# последний день, за который была сделана выплата любому клиенту
lastClaimed
```

## Functions

### claim()

Запрашивает выплату ревардов.

Формула расчета:

```
minerReward = stake / summary * dayReward
```

где,
stake - количество токенов залоченных пользователем
summary - общее количество токенов залоченных в этот день
dayReward - ревард за день

У функции есть только один параметр - адрес который ее вызвал. Этот адрес
ищется в `miners`. Начиная с `date` по каждому дню считается сколько
пользователь должен получить WBTC. После получение суммы, WBTC перечисляются
с адреса системы на адрес пользователя и запись в структуре `miners` для этого
пользователя удаляется. Если WBTC недостаточно, то вызов завершается ошибкой.

У функции есть лимит на размер выплаты. Если она настолько маленькая, что
при делении получается большая погрешность, то функция выдает ошибку.

Устанавливается значение переменной `lastClaimed`.

### canClaim() view

Определяет может ли пользователь сделать claim.

### stake(amount)

Эта функция забирает с баланса пользователя токены H24 и создает запись в
`miners` с завтрашней датой. Так же апдейтится `summary`. Если у пользователя
уже есть застейканные токены, то вызывается claim(), таким образом при каждом
вызове stake() у пользователя начинается отсчет заново, а все что должно
выплатится - выплачивается. Если за вчерашнее число не зарепорчен reward, то
выплаты не происходит, выдается ошибка.

### unstake(amount)

Аналогично с stake() делается выплата. В `miners` создается новая запись, c
завтрашней датой и новым amount, если он остался.

### unstakeAll()

Аналогично unstake() только запись в `miners` удаляется и новая не создается.

### canUnstake() view

Определяет может ли пользователь сделать unstake.

### getStake(addr) view

Возвращает размер стейка для адреса.

### getReward(addr) view

Подсчитывает и возвращает размер реварда, который будет выплачен при вызове
claim().

### setReward(date, amount)

Устанавливает значение в структуре `rewards` для конкретной даты. Нельзя
установить значение для дня, который меньше `lastClaimed`. Это позволяет
корректировать значения ревардов, если за эти и последующие дни не было
выплат. Эту функцию может вызывать только адрес с ролью Oracle.

У функции есть лимиты, например нельзя установить ревард за день больше чем
1M WBTC.

## WBTC

Все WBTC хранятся на отдельном адресе, только его владелец может напрямую
переводить токены. Этот адрес дал approve (стандартная функция ERC20) для
адреса смарт контракта на распоряжение WBTC в нужном объеме. С помощью этого
механизма можно гибко регулировать какими средствами может располагать смарт
контракт для выплат. При необходимости заблокировать, отобрав approve.

## Oracle

Бекенд сервис, который подсчитывает намайненные BTC и записывает количество в
блокчейн с помощью вызова функции `setReward()`.

## Demo Web UI

Демонстирует как воспользоватся всеми функциями смарт контракта: stake,
unstake, getStake, getReward.
